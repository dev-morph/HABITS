name: Build and Deploy HABITS
on:
  push:
    branches:
    - main

jobs:
  my_job:
    name: deploy to staging
    environment: deploy
    runs-on: ubuntu-latest
    steps:
      # checkout
      - uses: actions/checkout@v4.1.0
      # frontend .env 생성
      - run: touch ./frontend/.env
      - run: echo "VUE_APP_KAKAO_REST_API_KEY=${{secrets.VUE_APP_KAKAO_REST_API_KEY}}" >> ./frontend/.env
      - run: echo "VUE_APP_KAKAO_REDIRECT_URI=${{secrets.VUE_APP_KAKAO_REDIRECT_URI}}" >> ./frontend/.env
      # backend .env 생성
      - run: touch ./backend/.env.dev
      - run: echo "KAKAO_CLIENT_ID=${{secrets.KAKAO_CLIENT_ID}}" >> ./backend/.env.dev
      - run: echo "KAKAO_REDIRECT_URI=${{secrets.KAKAO_REDIRECT_URI}}" >> ./backend/.env.dev
      - run: echo "JWT_SECRET=${{secrets.JWT_SECRET}}" >> ./backend/.env.dev
      - run: echo "AT_DURATION=${{secrets.AT_DURATION}}" >> ./backend/.env.dev
      - run: echo "DATABASE_URL=${{secrets.DATABASE_URL}}" >> ./backend/.env.dev
      # db .env 생성
      - run: touch ./db/.env
      - run: echo "MYSQL_ROOT_PASSWORD=${{secrets.MYSQL_ROOT_PASSWORD}}" >> ./db/.env
      - run: echo "MYSQL_DATABASE=${{secrets.MYSQL_DATABASE}}" >> ./db/.env
      # docker image build
      - run: docker-compose build
      - run: docker images
      # deploy.sh권한 부여
      - name: makeInstallPackage.sh 실행
        run: |
          chmod +x makeInstallPackage.sh
          ./makeInstallPackage.sh
      - name: Upload S3
        uses: shallwefootball/upload-s3-action@v1.3.3
        with:
          aws_key_id: ${{secrets.AWS_ACCESSKEY}}
          aws_secret_access_key: ${{secrets.AWS_SECRETKEY}}
          aws_bucket: morphhabits
          # directory to upload
          source_dir: ./installPackage
          # destination directory for upload
            
